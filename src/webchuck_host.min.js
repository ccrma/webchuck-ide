var GLOBAL_audioSend,GLOBAL_audioContext,theWasm,AudioContext=window.AudioContext||window.webkitAudioContext,audioContext=void 0,theChuck=void 0,theChuckAlmostReady=defer(),theChuckReady=defer(),filesToPreload=[],whereIsChuck=whereIsChuck||"https://chuck.stanford.edu/webchuck/src",currentChuckID=1,chuckPrint=function(e){};function defer(){var e,t,a=new Promise((a,r)=>{e=a,t=r});return a.resolve=e,a.reject=t,a}var readAsync=function(e,t,a){var r=new XMLHttpRequest;r.open("GET",e,!0),r.responseType="arraybuffer",r.onload=function e(){if(200==r.status||0==r.status&&r.response){t(r.response);return}a()},r.onerror=a,r.send(null)},asyncLoadFile=function(e,t,a){readAsync(e,function(e){t(new Uint8Array(e))},function(t){if(a)a();else throw'Loading data file "'+e+'" failed.'})},loadWasm=new Promise(function(e,t){asyncLoadFile(whereIsChuck+"/webchuck.wasm",e,t)}),preloadFilenames=async function(e){for(var t=[],a=0;a<e.length;a++)!function(e){t.push(new Promise(function(t,a){asyncLoadFile(e.serverFilename,function(a){filesToPreload.push({filename:e.virtualFilename,data:a}),t()},function(){console.error("Error fetching file:",e.serverFilename),t()})}))}(e[a]);await Promise.all(t)},startAudioContext=async function(){theWasm=await loadWasm,await (audioContext=new AudioContext({})).resume(),await audioContext.audioWorklet.addModule(whereIsChuck+"/webchuck.js")},startChuck=async function(){if(void 0===audioContext){await startAudioContext();var e=currentChuckID;currentChuckID++,GLOBAL_audioSend=new GainNode(audioContext,{gain:1}),GLOBAL_audioContext=audioContext,(theChuck=await createAChuck(e,theChuckReady)).connect(audioContext.destination),theChuck.connect(GLOBAL_audioSend),theChuckAlmostReady.resolve()}},createAChuck=function(e,t){var a,r=new AudioWorkletNode(audioContext,"chuck-node",{numberOfInputs:1,numberOfOutputs:1,outputChannelCount:[2],processorOptions:{chuckID:e,srate:audioContext.sampleRate,preloadedFiles:filesToPreload,wasm:theWasm}});return r.chuckID=e,(a=r).eventCallbacks={},a.deferredPromises={},a.eventCallbackCounter=0,a.deferredPromiseCounter=0,a.amReady=t,a.onprocessorerror=function(e){console.log(e)},a.port.onmessage=function(e){switch(e.data.type){case"initCallback":a.amReady&&a.amReady.resolve();break;case"console print":chuckPrint(e.data.message);break;case"eventCallback":e.data.callback in a.eventCallbacks&&a.eventCallbacks[e.data.callback]();break;case"intCallback":case"floatCallback":case"stringCallback":case"intArrayCallback":case"floatArrayCallback":e.data.callback in a.deferredPromises&&(a.deferredPromises[e.data.callback].resolve(e.data.result),delete a.deferredPromises[e.data.callback]);break;case"newShredCallback":e.data.callback in a.deferredPromises&&(e.data.shred>0?a.deferredPromises[e.data.callback].resolve(e.data.shred):a.deferredPromises[e.data.callback].reject("Running code failed"));break;case"replacedShredCallback":e.data.callback in a.deferredPromises&&(e.data.newShred>0?a.deferredPromises[e.data.callback].resolve({newShred:e.data.newShred,oldShred:e.data.oldShred}):a.deferredPromises[e.data.callback].reject("Replacing code failed"));break;case"removedShredCallback":e.data.callback in a.deferredPromises&&(e.data.shred>0?a.deferredPromises[e.data.callback].resolve(e.data.shred):a.deferredPromises[e.data.callback].reject("Removing code failed"))}},a.nextDeferID=function(){var e=a.deferredPromiseCounter++;return a.deferredPromises[e]=defer(),e},a.createFile=function(e,t,r){a.port.postMessage({type:"loadFile",directory:e,filename:t,data:r})},a.runCode=function(e){var t=a.nextDeferID();return a.port.postMessage({type:"runChuckCode",code:e,callback:t}),a.deferredPromises[t]},a.runCodeWithReplacementDac=function(e,t){var r=a.nextDeferID();return a.port.postMessage({type:"runChuckCodeWithReplacementDac",code:e,dac_name:t,callback:r}),a.deferredPromises[r]},a.runFile=function(e){var t=a.nextDeferID();return a.port.postMessage({type:"runChuckFile",filename:e,callback:t}),a.deferredPromises[t]},a.runFileWithReplacementDac=function(e,t){var r=a.nextDeferID();return a.port.postMessage({type:"runChuckFileWithReplacementDac",filename:e,dac_name:t,callback:r}),a.deferredPromises[r]},a.runFileWithArgs=function(e,t){var r=a.nextDeferID();return a.port.postMessage({type:"runChuckFileWithArgs",filename:e,colon_separated_args:t,callback:r}),a.deferredPromises[r]},a.runFileWithArgsWithReplacementDac=function(e,t,r){var n=a.nextDeferID();return a.port.postMessage({type:"runChuckFileWithArgs",filename:e,colon_separated_args:t,dac_name:r,callback:n}),a.deferredPromises[n]},a.replaceCode=function(e){var t=a.nextDeferID();return a.port.postMessage({type:"replaceChuckCode",code:e,callback:t}),a.deferredPromises[t]},a.replaceCodeWithReplacementDac=function(e,t){var r=a.nextDeferID();return a.port.postMessage({type:"replaceChuckCodeWithReplacementDac",code:e,dac_name:t,callback:r}),a.deferredPromises[r]},a.replaceFile=function(e){var t=a.nextDeferID();return a.port.postMessage({type:"replaceChuckFile",filename:e,callback:t}),a.deferredPromises[t]},a.replaceFileWithReplacementDac=function(e,t){var r=a.nextDeferID();return a.port.postMessage({type:"replaceChuckFileWithReplacementDac",filename:e,dac_name:t,callback:r}),a.deferredPromises[r]},a.replaceFileWithArgs=function(e,t){var r=a.nextDeferID();return a.port.postMessage({type:"replaceChuckFileWithArgs",filename:e,colon_separated_args:t,callback:r}),a.deferredPromises[r]},a.replaceFileWithArgsWithReplacementDac=function(e,t,r){var n=a.nextDeferID();return a.port.postMessage({type:"replaceChuckFileWithArgs",filename:e,colon_separated_args:t,dac_name:r,callback:n}),a.deferredPromises[n]},a.removeLastCode=function(){var e=a.nextDeferID();return a.port.postMessage({type:"removeLastCode",callback:e}),a.deferredPromises[e]},a.removeShred=function(e){var t=a.nextDeferID();return a.port.postMessage({type:"removeShred",shred:e,callback:t}),a.deferredPromises[t]},a.isShredActive=function(e){var t=a.nextDeferID();return a.port.postMessage({type:"isShredActive",shred:e,callback:t}),a.deferredPromises[t]},a.setInt=function(e,t){a.port.postMessage({type:"setChuckInt",variable:e,value:t})},a.getInt=function(e){var t=a.nextDeferID();return a.port.postMessage({type:"getChuckInt",variable:e,callback:t}),a.deferredPromises[t]},a.setFloat=function(e,t){a.port.postMessage({type:"setChuckFloat",variable:e,value:t})},a.getFloat=function(e){var t=a.nextDeferID();return a.port.postMessage({type:"getChuckFloat",variable:e,callback:t}),a.deferredPromises[t]},a.setString=function(e,t){a.port.postMessage({type:"setChuckString",variable:e,value:t})},a.getString=function(e){var t=a.nextDeferID();return a.port.postMessage({type:"getChuckString",variable:e,callback:t}),a.deferredPromises[t]},a.signalEvent=function(e){a.port.postMessage({type:"signalChuckEvent",variable:e})},a.broadcastEvent=function(e){a.port.postMessage({type:"broadcastChuckEvent",variable:e})},a.listenForEventOnce=function(e,t){var r=a.eventCallbackCounter++;a.eventCallbacks[r]=t,a.port.postMessage({type:"listenForChuckEventOnce",variable:e,callback:r})},a.startListeningForEvent=function(e,t){var r=a.eventCallbackCounter++;return a.eventCallbacks[r]=t,a.port.postMessage({type:"startListeningForChuckEvent",variable:e,callback:r}),r},a.stopListeningForEvent=function(e,t){a.port.postMessage({type:"stopListeningForChuckEvent",variable:e,callback:t})},a.setIntArray=function(e,t){a.port.postMessage({type:"setGlobalIntArray",variable:e,values:t})},a.getIntArray=function(e){var t=a.nextDeferID();return a.port.postMessage({type:"getGlobalIntArray",variable:e,callback:t}),a.deferredPromises[t]},a.setIntArrayValue=function(e,t,r){a.port.postMessage({type:"setGlobalIntArrayValue",variable:e,index:t,value:r})},a.getIntArrayValue=function(e,t){var r=a.nextDeferID();return a.port.postMessage({type:"getGlobalIntArrayValue",variable:e,index:t,callback:r}),a.deferredPromises[r]},a.setAssociativeIntArrayValue=function(e,t,r){a.port.postMessage({type:"setGlobalAssociativeIntArrayValue",variable:e,key:t,value:r})},a.getAssociativeIntArrayValue=function(e,t){var r=a.nextDeferID();return a.port.postMessage({type:"getGlobalAssociativeIntArrayValue",variable:e,key:t,callback:r}),a.deferredPromises[r]},a.setFloatArray=function(e,t){a.port.postMessage({type:"setGlobalFloatArray",variable:e,values:t})},a.getFloatArray=function(e){var t=a.nextDeferID();return a.port.postMessage({type:"getGlobalFloatArray",variable:e,callback:t}),a.deferredPromises[t]},a.setFloatArrayValue=function(e,t,r){a.port.postMessage({type:"setGlobalFloatArrayValue",variable:e,index:t,value:r})},a.getFloatArrayValue=function(e,t){var r=a.nextDeferID();return a.port.postMessage({type:"getGlobalFloatArrayValue",variable:e,index:t,callback:r}),a.deferredPromises[r]},a.setAssociativeFloatArrayValue=function(e,t,r){a.port.postMessage({type:"setGlobalAssociativeFloatArrayValue",variable:e,key:t,value:r})},a.getAssociativeFloatArrayValue=function(e,t){var r=a.nextDeferID();return a.port.postMessage({type:"getGlobalAssociativeFloatArrayValue",variable:e,key:t,callback:r}),a.deferredPromises[r]},a.clearChuckInstance=function(){a.port.postMessage({type:"clearChuckInstance"})},a.clearGlobals=function(){a.port.postMessage({type:"clearGlobals"})},r},createASubChuck=function(e,t,a){var r,n=new AudioWorkletNode(audioContext,"chuck-sub-node",{numberOfInputs:1,numberOfOutputs:1,outputChannelCount:[1],processorOptions:{chuckID:e.chuckID,dac:t}});return(r=n).myChuck=e,r.dac=t,r.amReady=a,r.port.onmessage=function(e){"initCallback"===e.data.type&&r.amReady&&r.amReady.resolve()},r.createFile=function(e,t,a){return r.myChuck.createFile(e,t,a)},r.runCode=function(e){return r.myChuck.runCodeWithReplacementDac(e,r.dac)},r.runCodeWithReplacementDac=function(e,t){return r.myChuck.runCodeWithReplacementDac(e,t)},r.runFile=function(e){return r.myChuck.runFileWithReplacementDac(e,r.dac)},r.runFileWithReplacementDac=function(e,t){return r.myChuck.runFileWithReplacementDac(e,t)},r.runFileWithArgs=function(e,t){return r.myChuck.runFileWithArgsWithReplacementDac(e,t,r.dac)},r.runFileWithArgsWithReplacementDac=function(e,t,a){return r.myChuck.runFileWithArgsWithReplacementDac(e,t,a)},r.replaceCode=function(e){return r.myChuck.replaceCodeWithReplacementDac(e,r.dac)},r.replaceCodeWithReplacementDac=function(e,t){return r.myChuck.replaceCodeWithReplacementDac(e,t)},r.replaceFile=function(e){return r.myChuck.replaceFileWithReplacementDac(e,r.dac)},r.replaceFileWithReplacementDac=function(e,t){return r.myChuck.replaceFileWithReplacementDac(e,t)},r.replaceFileWithArgs=function(e,t){return r.myChuck.replaceFileWithArgsWithReplacementDac(e,t,r.dac)},r.replaceFileWithArgsWithReplacementDac=function(e,t,a){return r.myChuck.replaceFileWithArgsWithReplacementDac(e,t,a)},r.removeLastCode=function(){return r.myChuck.removeLastCode()},r.removeShred=function(e){return r.myChuck.removeShred(e)},r.isShredActive=function(e){return r.myChuck.isShredActive(e)},r.setInt=function(e,t){return r.myChuck.setInt(e,t)},r.getInt=function(e){return r.myChuck.getInt(e)},r.setFloat=function(e,t){return r.myChuck.setFloat(e,t)},r.getFloat=function(e){return r.myChuck.getFloat(e)},r.setString=function(e,t){return r.myChuck.setString(e,t)},r.getString=function(e){return r.myChuck.getString(e)},r.signalEvent=function(e){return r.myChuck.signalEvent(e)},r.broadcastEvent=function(e){return r.myChuck.broadcastEvent(e)},r.listenForEventOnce=function(e,t){return r.myChuck.listenForEventOnce(e,t)},r.startListeningForEvent=function(e,t){return r.myChuck.startListeningForEvent(e,t)},r.stopListeningForEvent=function(e,t){return r.myChuck.stopListeningForEvent(e,t)},r.setIntArray=function(e,t){return r.myChuck.setIntArray(e,t)},r.getIntArray=function(e){return r.myChuck.getIntArray(e)},r.setIntArrayValue=function(e,t,a){return r.myChuck.setIntArrayValue(e,t,a)},r.getIntArrayValue=function(e,t){return r.myChuck.getIntArrayValue(e,t)},r.setAssociativeIntArrayValue=function(e,t,a){return r.myChuck.setAssociativeIntArrayValue(e,t,a)},r.getAssociativeIntArrayValue=function(e,t){return r.myChuck.getAssociativeIntArrayValue(e,t)},r.setFloatArray=function(e,t){return r.myChuck.setFloatArray(e,t)},r.getFloatArray=function(e){return r.myChuck.getFloatArray(e)},r.setFloatArrayValue=function(e,t,a){return r.myChuck.setFloatArrayValue(e,t,a)},r.getFloatArrayValue=function(e,t){return r.myChuck.getFloatArrayValue(e,t)},r.setAssociativeFloatArrayValue=function(e,t,a){return r.myChuck.setAssociativeFloatArrayValue(e,t,a)},r.getAssociativeFloatArrayValue=function(e,t){return r.myChuck.getAssociativeFloatArrayValue(e,t)},r.clearChuckInstance=function(){return r.myChuck.clearChuckInstance()},r.clearGlobals=function(){return r.myChuck.clearGlobals()},n};
